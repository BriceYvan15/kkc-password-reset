<!DOCTYPE html>
<html>
<head>
  <title>Redirection vers KKC Réservation</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <p style="font-family: Arial, sans-serif; text-align: center; margin-top: 50px;">Redirection vers l'application KKC Réservation...</p>
  <script>
    // Lire l'URL complète
    const urlParams = new URLSearchParams(window.location.search);
    let email = urlParams.get('email');

    const hashParams = new URLSearchParams((window.location.hash || '').replace(/^#/, ''));
    const hashAccessToken = hashParams.get('access_token');
    const hashRefreshToken = hashParams.get('refresh_token');
    const hashType = hashParams.get('type');
    
    // Essayer de récupérer soit les params directs, soit depuis une URL Supabase complète
    let token = urlParams.get('token');
    let type = urlParams.get('type');
    let redirectTo = urlParams.get('redirect_to');
    
    // Si pas de token direct, chercher dans une URL Supabase (cas où le template envoie l'URL complète)
    if (!token) {
      const supabaseUrl = urlParams.get('url') || window.location.search.substring(1);
      const match = supabaseUrl.match(/token=([^&]+)/);
      if (match) token = match[1];
      
      const typeMatch = supabaseUrl.match(/type=([^&]+)/);
      if (typeMatch) type = typeMatch[1];
      
      const redirectMatch = supabaseUrl.match(/redirect_to=([^&]+)/);
      if (redirectMatch) redirectTo = decodeURIComponent(redirectMatch[1]);
      
      // Essayer d'extraire l'email depuis l'URL Supabase
      const emailMatch = supabaseUrl.match(/email=([^&]+)/);
      if (emailMatch) email = decodeURIComponent(emailMatch[1]);
    }

    redirectTo = redirectTo || 'myapp://update-password';
    
    console.log('Params extraits:', { token, type, redirectTo, email, hashAccessToken, hashRefreshToken, hashType });
    
    if (hashAccessToken && hashRefreshToken && hashType === 'recovery' && redirectTo) {
      const appUrl = redirectTo + '?access_token=' + encodeURIComponent(hashAccessToken) + '&refresh_token=' + encodeURIComponent(hashRefreshToken) + '&type=recovery';
      console.log('Redirection vers:', appUrl);
      window.location.href = appUrl;
    } else if (token && type === 'recovery' && redirectTo) {
      const appUrl = redirectTo + '?access_token=' + encodeURIComponent(token) + '&type=recovery&email=' + encodeURIComponent(email || '');
      console.log('Redirection vers:', appUrl);
      window.location.href = appUrl;
    } else {
      document.body.innerHTML = '<p style="font-family: Arial, sans-serif; text-align: center; margin-top: 50px; color: red;">Lien de réinitialisation invalide ou expiré.</p>';
    }
  </script>
</body>
</html>
